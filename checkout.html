<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Niva Health Care</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/checkout.css">
  <link rel="stylesheet" href="css/new.css">
</head>
<body>

</head>
<body>


  <!-- Header -->
<header>
  <!-- Desktop Header -->
  <div class="desktop-header">
    <div class="logo-location">
      <div class="logo-section">
        <div class="lab-name">
          <span class="niva">Niva</span>
          <span class="healthcare">Health Kare</span>
        </div>
      </div>
    </div>

  </div>

  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="logo-section">
      <div class="lab-name">
        <span class="niva">Niva</span>
        <span class="healthcare">Health Kare</span>
      </div>
    </div>
  </div>
</header>



<!-- Checkout Steps -->
<div class="checkout-steps-wrapper">
  <div class="checkout-steps">

    <div class="checkout-step-item is-active">
      <span class="step-number">1</span>
      <span class="step-label">Order Summary</span>
    </div>

    <div class="checkout-step-divider"></div>

    <div class="checkout-step-item">
      <span class="step-number">2</span>
      <span class="step-label">Member Details</span>
    </div>

    <div class="checkout-step-divider"></div>

    <div class="checkout-step-item">
      <span class="step-number">3</span>
      <span class="step-label">Payment</span>
    </div>

  </div>
</div>



  <div class="checkout-container" id="mainContent">

    <!-- Order Summary -->
<div class="banner order-banner" id="orderBanner">

  <h2>üì¶ Order Summary</h2>

<!-- Ordered Items List -->
<div class="order-items-list" id="orderItemsList">
  <!-- Items injected by JS -->
</div>


  <div class="order-stats">
    <span class="badge">Items: <strong id="summaryItems">0</strong></span>
    <span class="badge">Total: <strong id="summaryAmount">‚Çπ0</strong></span>
  </div>
</div><div class="banner member-banner" id="memberBanner">
  <h2>üë§ Patient Details</h2>

  <form id="memberForm">

    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="name" placeholder="Enter full name" required>
    </div>

    <div class="form-group">
      <label>Mobile Number</label>
      <input type="tel" id="phone" placeholder="10-digit mobile number" required>
    </div>

    <div class="form-group">
      <label>Service Address</label>
      <textarea id="address" rows="2" placeholder="Enter complete address" required></textarea>

      <!-- Location helper -->
      <button type="button" class="location-btn" onclick="useCurrentLocation()">
        üìç Use current location
      </button>
    </div>

    <button type="button" class="btn" onclick="proceedToPayment()">
      Continue
    </button>

  </form>
</div>


    
<!-- Payment -->
<div class="banner payment-banner hidden" id="paymentBanner">
  <h2>üí≥ Payment Options</h2>
  <div class="payment-options">
    <label><input type="radio" name="paymentMethod" value="upi"> Pay via UPI</label>
    <label><input type="radio" name="paymentMethod" value="cod"> Payment on Visit</label>

    <div id="upiSection" class="hidden">
      <h4>Scan & Pay</h4>
      <img src="images/qr_code.png" alt="UPI QR" class="upi-qr">
      <p><strong>UPI ID:</strong> yourlab@upi</p>
      <p><strong>Bank:</strong> ABC Bank</p>
      <p><strong>IFSC:</strong> ABCD0123456</p>
      <p><strong>Account No:</strong> 1234567890</p>

      <!-- Highlighted friendly message -->
<div style="background-color: #ffeb3b; padding: 10px; border-radius: 5px; margin-top: 10px; font-weight: bold; font-size: 14px; color: #000000; text-align: center;">
  <p style="margin: 5px 0;">Open your payment app, scan the QR code, or use the bank details to make your payment. It's quick and easy! üòä</p>
  <p style="margin: 5px 0;">Once we receive your payment, we‚Äôll send you a confirmation email so you know everything‚Äôs all set. Thank you for choosing us!</p>
</div>


    </div>


        <!-- ‚úÖ Place Order button -->
          <button type="button" class="btn" onclick="placeOrder(event)">Place Order</button>

      </div>
    </div>

  </div>

  <!-- Overlay for Payment modal -->
  <div class="overlay hidden" id="overlay"></div>

  <!-- Success (Confirmation) OUTSIDE the container so it never gets hidden with it) -->
  <div id="successBanner" class="banner success-banner hidden">
    ‚úÖ Payment Successful! Your order is confirmed.<br>
    We‚Äôll contact you shortly with your booking details.
  </div>

<script>
/* ===============================
   CART HELPERS
================================ */

function getCartItems() {
  try {
    return JSON.parse(localStorage.getItem("cartItems")) || [];
  } catch (e) {
    return [];
  }
}

/* ===============================
   CHECKOUT SUMMARY
================================ */

function updateCheckoutSummary() {
  const itemsEl = document.getElementById("summaryItems");
  const amountEl = document.getElementById("summaryAmount");
  if (!itemsEl || !amountEl) return;

  let cartItems = getCartItems();
  let total = cartItems.reduce(
    (sum, item) => sum + (Number(item.price) || 0),
    0
  );

  itemsEl.textContent = cartItems.length;
  amountEl.textContent = "‚Çπ" + total;
}

/* ===============================
   PAYMENT MODAL
================================ */

function proceedToPayment() {
  const memberForm = document.getElementById("memberForm");

  if (!memberForm.checkValidity()) {
    memberForm.reportValidity();
    return;
  }

  const paymentBanner = document.getElementById("paymentBanner");
  const overlay = document.getElementById("overlay");

  overlay.classList.remove("hidden");
  overlay.style.opacity = 0;
  overlay.style.transition = "opacity 0.3s ease";
  setTimeout(() => (overlay.style.opacity = 1), 10);

  paymentBanner.classList.remove("hidden");
  paymentBanner.style.opacity = 0;
  paymentBanner.style.transform = "translate(-50%, -60%) scale(0.95)";
  paymentBanner.style.transition = "all 0.3s ease";
  setTimeout(() => {
    paymentBanner.style.opacity = 1;
    paymentBanner.style.transform = "translate(-50%, -50%) scale(1)";
  }, 10);

  document.body.style.overflow = "hidden";
}

function hidePaymentModal() {
  const paymentBanner = document.getElementById("paymentBanner");
  const overlay = document.getElementById("overlay");

  paymentBanner.style.opacity = 0;
  paymentBanner.style.transform = "translate(-50%, -60%) scale(0.95)";
  overlay.style.opacity = 0;

  setTimeout(() => {
    paymentBanner.classList.add("hidden");
    overlay.classList.add("hidden");
    document.body.style.overflow = "";
  }, 300);
}

/* ===============================
   PLACE ORDER (BACKEND)
================================ */

let upiShown = false;
const API_BASE = "http://localhost:5000";

async function postJSON(path, payload) {
  const res = await fetch(API_BASE + path, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  return res.json();
}

async function placeOrder(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }

  const selected = document.querySelector(
    'input[name="paymentMethod"]:checked'
  );
  if (!selected) {
    alert("Please select a payment method");
    return;
  }

  if (selected.value === "upi" && !upiShown) {
    document.getElementById("upiSection").classList.remove("hidden");
    upiShown = true;
    return;
  }

  const bookingData = {
    type: "checkout",
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    address: document.getElementById("address").value,
    email: document.getElementById("email")?.value || "",
    preferred_date: document.getElementById("preferredDate")?.value || "",
    preferred_time: document.getElementById("preferredTime")?.value || "",
    payment_mode: selected.value,
    items: getCartItems(),
    total_amount: getCartItems().reduce(
      (sum, item) => sum + (Number(item.price) || 0),
      0
    )
  };

  const successBanner = document.getElementById("successBanner");
  successBanner.innerHTML =
    selected.value === "upi"
      ? "‚úÖ Your payment is under verification.<br>We will reach you soon.<br>Thank you!"
      : "‚úÖ Order placed successfully!<br>We will contact you shortly.";

  successBanner.classList.remove("hidden");
  successBanner.style.display = "flex";

  document.getElementById("paymentBanner").classList.add("hidden");
  document.getElementById("overlay").classList.add("hidden");

  setTimeout(() => {
    successBanner.style.display = "none";
  }, 100000);

  try {
    const r = await postJSON("/api/book", bookingData);
    if (r && r.success) {
      localStorage.removeItem("cartItems");
    }
  } catch (err) {
    console.error("Backend error:", err);
  }
}

/* ===============================
   ORDER ITEMS LIST (READ ONLY)
================================ */

function renderOrderItems() {
  const container = document.getElementById("orderItemsList");
  if (!container) return;

  let cart;
  try {
    cart = JSON.parse(localStorage.getItem("cartItems"));
  } catch {
    cart = null;
  }

  if (!cart || !Array.isArray(cart) || cart.length === 0) {
    container.innerHTML =
      "<p style='font-size:13px;color:#666;'>No items added</p>";
    return;
  }

  container.innerHTML = "";

  cart.forEach((item, index) => {
    const row = document.createElement("div");
    row.className = "order-item-row";

    const label =
      item.name || item.title || item.service || `Item ${index + 1}`;

    row.innerHTML = `
      <div class="order-item-info">
        <span class="order-item-name">${label}</span>
      </div>
    `;

    container.appendChild(row);
  });
}

/* ===============================
   CURRENT LOCATION (ADDRESS)
================================ */

async function useCurrentLocation() {
  if (!navigator.geolocation) {
    alert("Location not supported on this device");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
        );
        const data = await response.json();
        if (data?.display_name) {
          document.getElementById("address").value = data.display_name;
        } else {
          alert("Unable to fetch address");
        }
      } catch {
        alert("Failed to fetch address");
      }
    },
    () => alert("Location permission denied")
  );
}

/* ===============================
   EVENTS
================================ */

document.addEventListener("DOMContentLoaded", () => {
  updateCheckoutSummary();
  renderOrderItems();

  const overlay = document.getElementById("overlay");
  if (overlay) overlay.addEventListener("click", hidePaymentModal);
});

window.addEventListener("storage", e => {
  if (e.key === "cartItems") updateCheckoutSummary();
});

window.addEventListener("focus", updateCheckoutSummary);

window.addEventListener("scroll", () => {
  const banner = document.getElementById("orderBanner");
  if (!banner) return;
  window.scrollY > 80
    ? banner.classList.add("is-sticky")
    : banner.classList.remove("is-sticky");
});
</script>


<script src="javascript/booking.js"></script>


</body>
</html>
